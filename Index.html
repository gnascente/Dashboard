<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Controle de Obra</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7c3aed"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/7c3aed/FFFFFF?text=Obra">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7c3aed',
                        accent: '#349e7b',
                        accentDark: '#2a7e62',
                        accentLight: '#66bba5',
                        highlight: '#d97706',
                        neutral: '#f5f1eb',
                        dangerTone: '#d9534f',
                        successTone: '#5cb85c',
                        sand: {
                            50: '#f5f1eb',
                            100: '#ece4d7',
                            200: '#e0d6c2'
                        },
                        clay: {
                            300: '#9a9187',
                            400: '#80776d',
                            500: '#665e55',
                            700: '#45403b',
                            900: '#2f2b27'
                        },
                        moss: {
                            200: '#c4d4ca',
                            400: '#7e9c8f',
                            500: '#5f8577',
                            600: '#4a766b',
                            700: '#3b5c52'
                        },
                        copper: {
                            400: '#d9a26a',
                            500: '#c47b36',
                            600: '#a9622a'
                        },
                        earthy: {
                            100: '#f9f6f1',
                            200: '#f0e9df',
                            300: '#e2d7c7',
                            400: '#d5c7b3'
                        },
                        terracotta: {
                            100: '#f7e9e3',
                            500: '#c35d3b',
                            600: '#a44b2d'
                        },
                        olive: {
                            200: '#d4ddc9',
                            500: '#7b9362',
                            600: '#64774f'
                        }
                    },
                    boxShadow: {
                        soft: '0 12px 30px rgba(74, 118, 107, 0.08)'
                    }
                }
            }
        };
    </script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "bfad3d68-ae1c-4b4c-90a7-dc211aa11727",
        });
      });
    </script>
    
    <style>
        :root {
            --bg-base: #f7f7f7;
            --surface: #ffffff;
            --surface-muted: #ede4d8;
            --surface-strong: #e0d6c4;
            --border-soft: #e5e7eb;
            --border-strong: #d1d5db;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --accent: #7c3aed;
            --accent-hover: #6d28d9;
            --accent-soft: rgba(124, 58, 237, 0.12);
            --highlight: #f59e0b;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --success: #22c55e;
            --success-soft: rgba(34, 197, 94, 0.18);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-base);
            color: var(--text-primary);
        }

        .bg-gray-100 { background-color: var(--bg-base) !important; }
        .bg-white { background-color: var(--surface) !important; }
        .text-gray-800 { color: var(--text-primary) !important; }
        .text-gray-700 { color: var(--text-secondary) !important; }
        .text-gray-600 { color: var(--text-muted) !important; }
        .border-gray-200 { border-color: var(--border-soft) !important; }
        .border-gray-300 { border-color: var(--border-strong) !important; }
        
        .bg-violet-500 { background-color: var(--accent) !important; }
        .bg-violet-600 { background-color: var(--accent-hover) !important; }
        .hover\:bg-violet-600:hover { background-color: var(--accent-hover) !important; }
        .hover\:bg-violet-700:hover { background-color: var(--accent-hover) !important; }
        .text-violet-600 { color: var(--accent-hover) !important; }
        .text-violet-500 { color: var(--accent) !important; }
        .border-violet-600 { border-color: var(--accent-hover) !important; }
        .focus\:border-violet-500:focus { border-color: var(--accent) !important; }
        .focus\:ring-violet-500:focus { --tw-ring-color: rgba(124, 58, 237, 0.4) !important; }
        .bg-violet-50 { background-color: var(--accent-soft) !important; }
        
        .bg-red-500 { background-color: var(--danger) !important; }
        .hover\:bg-red-600:hover { background-color: var(--danger-hover) !important; }
        .text-red-600 { color: var(--danger-hover) !important; }
        .bg-red-100 { background-color: rgba(239, 68, 68, 0.15) !important; }
        
        .text-green-500, .text-green-600 { color: var(--success) !important; }
        .bg-green-500 { background-color: var(--success) !important; }
        .peer-checked\:bg-green-500:checked { background-color: var(--success) !important; }
        .bg-green-50 { background-color: var(--success-soft) !important; }

        .bg-amber-100 { background-color: #fef3c7 !important; }
        .text-amber-800 { color: #92400e !important; }
        .bg-amber-500 { background-color: var(--highlight) !important; }
        .hover\:bg-amber-600:hover { background-color: #d97706 !important; }
        
        #menu-lateral,
        #filtro-avancado-panel,
        #lancamento-modal > div,
        #backup-content > div,
        #galeria-modal > div,
        #add-categoria-modal-content,
        #add-carteira-modal-content,
        #add-fornecedor-modal-content,
        #delete-item-modal > div,
        #confirmacao-modal > div {
            background-color: var(--surface) !important;
            border-radius: 18px;
            border: 1px solid rgba(217, 206, 192, 0.6);
            box-shadow: 0 24px 45px rgba(47, 43, 39, 0.12);
        }

        #totalizer-footer-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(14px);
            border-top: 1px solid rgba(229, 231, 235, 0.9);
        }

        footer { box-shadow: 0 -8px 30px rgba(47, 43, 39, 0.08); }

        #main-content nav button { border-bottom-width: 3px; transition: all 0.2s ease; padding-bottom: 0.6rem;}
        #main-content nav button[aria-selected="true"],
        #main-content nav button.border-violet-600 {
            color: var(--accent-hover) !important;
            border-color: var(--accent-hover) !important;
        }
        #main-content nav button:hover { color: var(--accent) !important; }

        #abrir-novo-lancamento-modal { box-shadow: var(--accent-soft) 0px 18px 35px; }

        @keyframes pulse {
            50% { transform: scale(1.05); }
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="menu-lateral-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
    <div id="menu-lateral" class="fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-40 transform -translate-x-full transition-transform duration-300">
        </div>
    <div id="filtro-avancado-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="filtro-avancado-panel" class="fixed top-0 right-0 h-full w-80 max-w-full bg-white shadow-lg z-50 transform translate-x-full transition-transform duration-300 flex flex-col">
        </div>

    <div class="container mx-auto max-w-md p-4 pb-28">
        <header class="flex items-center justify-between my-4">
            </header>

        <div id="main-content">
            </div>

        <div id="backup-content" class="hidden">
            <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                 <div class="text-center pb-6 mb-6 border-b border-dashed">
                    <svg class="mx-auto h-20 w-20 text-violet-500/50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <h2 class="text-2xl font-semibold text-gray-800">Backup</h2>
                    <p class="text-sm text-gray-500 mt-1">Exporte ou importe os dados da sua obra</p>
                </div>
                <div class="space-y-6">
                    <div>
                        <p class="text-xs uppercase tracking-[0.24em] text-gray-500">Segurança</p>
                        <h3 class="text-lg font-bold text-gray-800">Exportar Dados</h3>
                        <p class="text-sm text-gray-600 mt-1">Salve todos os seus dados, incluindo fotos, em um único arquivo de backup.</p>
                        <button id="exportar-btn" class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-violet-600 hover:bg-violet-700">Exportar Backup</button>
                    </div>
                    <div class="border-t border-dashed pt-6">
                        <p class="text-xs uppercase tracking-[0.24em] text-gray-500">Restauração</p>
                        <h3 class="text-lg font-bold text-gray-800">Importar Dados</h3>
                        <p class="text-sm text-gray-600 mt-1">Carregue um arquivo de backup para restaurar seus dados. <strong class="text-red-600">Atenção:</strong> Isso substituirá todos os dados atuais.</p>
                        <input type="file" id="importar-input" class="hidden" accept=".json, .txt">
                        <button id="importar-btn" class="mt-4 w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Selecionar Arquivo</button>
                    </div>
                </div>
            </div>
        </div>
        <footer id="totalizer-footer" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto transition-transform duration-300" data-collapsed="false">
            <div id="totalizer-footer-content" class="relative px-4 py-2 flex items-center gap-4">
                 <button id="toggle-totalizer-btn" class="absolute -top-3.5 left-1/2 -translate-x-1/2 bg-white w-12 h-7 rounded-full flex items-center justify-center border shadow-md focus:outline-none focus:ring-2 focus:ring-violet-500/40">
                    <svg id="totalizer-arrow-down" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    <svg id="totalizer-arrow-up" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                </button>
                <div id="resumo-total" class="flex-grow flex justify-between items-center text-gray-700">
                </div>
                <button id="abrir-novo-lancamento-modal" class="relative bg-violet-600 hover:bg-violet-700 text-white rounded-full w-14 h-14 flex-shrink-0 flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                   </svg>
               </button>
            </div>
        </footer>
    </div>
    
    <script>
        // O início do seu script JS permanece o mesmo...

        // --- SELETORES DE DOM --- (todo o bloco permanece igual)
        // --- VARIÁVEIS DE ESTADO --- (todo o bloco permanece igual)
        // --- PERSISTÊNCIA DE DADOS --- (todo o bloco permanece igual)
        // ... e assim por diante, até chegar no listener do DOMContentLoaded

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            carregarDados();
            atualizarTodosDropdownsEPopups();
            renderizarLancamentos();

            // ... todos os outros listeners permanecem iguais ...

            exportarBtn.addEventListener('click', () => {
                const dataToSave = { lancamentos, categorias, carteiras, fornecedores };
                const dataStr = JSON.stringify(dataToSave, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.download = `backup_obra_${new Date().toISOString().slice(0, 10)}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                mostrarNotificacao('Backup exportado com sucesso!', true);

                // --- CÓDIGO ONE SIGNAL ATUALIZADO (v16) ---
                window.OneSignalDeferred.push(function(OneSignal) {
                    OneSignal.sendSelfNotification(
                        /* Title */
                        "Backup da Obra Realizado!",
                        /* Message */
                        `O backup foi gerado e salvo com sucesso em ${new Date().toLocaleTimeString()}.`,
                        /* URL */
                        window.location.href
                    );
                });
                // --- FIM DO CÓDIGO ATUALIZADO ---
            });
            
            importarBtn.addEventListener('click', () => importarInput.click());
            // ... resto do listener do importarBtn ...

            // ... todo o restante do seu código JavaScript permanece igual ...
        });

        const alternarAbas = (aba) => {
            // ... esta função permanece a mesma ...
        };

        // Adicionando o código completo para facilitar a substituição
        // --- DADOS GLOBAIS ---
        let categorias = ['Estrutura e Vedações', 'Acabamentos', 'Terraplanagem/Tratores', 'Hidráulica', 'Elétrica'];
        let carteiras = ['Conta Corrente', 'Investimentos'];
        let fornecedores = ['Leroy Merlin', 'C&C Casa e Construção'];
        let lancamentos = [
            { id: 1, data: '2025-10-06', carteira: 'Conta Corrente', categoria: 'Estrutura e Vedações', descricao: 'Pisos 12 de 12 parcelas', valor: 3317.16, pago: false, fotos: ['https://via.placeholder.com/150'], fornecedor: 'Leroy Merlin' },
            { id: 2, data: '2025-09-25', carteira: 'Investimentos', categoria: 'Terraplanagem/Tratores', descricao: '10X10 Caixa d\'água e tubulações', valor: 1132.70, pago: true, fotos: [], fornecedor: 'C&C Casa e Construção' },
            { id: 3, data: '2025-09-25', carteira: 'Conta Corrente', categoria: 'Terraplanagem/Tratores', descricao: 'Pisos 11 de 12 parcelas', valor: 3317.16, pago: true, fotos: [], fornecedor: 'Leroy Merlin' },
            { id: 4, data: '2025-08-10', carteira: 'Conta Corrente', categoria: 'Acabamentos', descricao: 'Tinta para área externa', valor: 850.00, pago: true, fotos: [], fornecedor: 'C&C Casa e Construção' }
        ];
        const containerLista = document.getElementById('lancamentos-lista');
        const resumoTotalContainer = document.getElementById('resumo-total');
        const campoPesquisa = document.getElementById('campo-pesquisa');
        const lancamentosTabBtn = document.getElementById('lancamentos-tab-btn');
        const relatoriosTabBtn = document.getElementById('relatorios-tab-btn');
        const lancamentosContent = document.getElementById('lancamentos-content');
        const relatoriosContent = document.getElementById('relatorios-content');
        const mainContent = document.getElementById('main-content');
        const backupContent = document.getElementById('backup-content');
        const lancamentoModal = document.getElementById('lancamento-modal');
        const lancamentoForm = document.getElementById('lancamento-form');
        const fecharLancamentoModalBtn = document.getElementById('fechar-lancamento-modal');
        const cancelarLancamentoBtn = document.getElementById('cancelar-lancamento');
        const abrirNovoLancamentoBtn = document.getElementById('abrir-novo-lancamento-modal');
        const lancamentoModalTitulo = document.getElementById('lancamento-modal-titulo');
        const categoriaDropdown = document.getElementById('lancamento-categoria');
        const carteiraDropdown = document.getElementById('lancamento-carteira');
        const fornecedorDropdown = document.getElementById('lancamento-fornecedor');
        const addCategoriaModal = document.getElementById('add-categoria-modal');
        const addCategoriaForm = document.getElementById('add-categoria-form');
        const addCarteiraModal = document.getElementById('add-carteira-modal');
        const addCarteiraForm = document.getElementById('add-carteira-form');
        const addFornecedorModal = document.getElementById('add-fornecedor-modal');
        const addFornecedorForm = document.getElementById('add-fornecedor-form');
        const btnGaleriaUpload = document.getElementById('btn-galeria-upload');
        const btnCameraUpload = document.getElementById('btn-camera-upload');
        const galeriaInput = document.getElementById('galeria-input');
        const cameraInput = document.getElementById('camera-input');
        const fotosThumbnailsContainer = document.getElementById('fotos-thumbnails-container');
        const notificacaoModal = document.getElementById('notificacao-modal');
        const notificacaoMensagem = document.getElementById('notificacao-mensagem');
        const galeriaModal = document.getElementById('galeria-modal');
        const galeriaContainer = document.getElementById('galeria-fotos-container');
        const fecharGaleriaBtn = document.getElementById('fechar-galeria');
        const galeriaTitulo = document.getElementById('galeria-titulo');
        const zoomModal = document.getElementById('zoom-modal');
        const zoomedImage = document.getElementById('zoomed-image');
        const fecharZoomBtn = document.getElementById('fechar-zoom');
        const abrirMenuBtn = document.getElementById('abrir-menu-btn');
        const menuLateral = document.getElementById('menu-lateral');
        const menuLateralOverlay = document.getElementById('menu-lateral-overlay');
        const menuLancamentosBtn = document.getElementById('menu-lancamentos-btn');
        const menuBackupBtn = document.getElementById('menu-backup-btn');
        const exportarBtn = document.getElementById('exportar-btn');
        const importarBtn = document.getElementById('importar-btn');
        const importarInput = document.getElementById('importar-input');
        const tituloPrincipal = document.getElementById('titulo-principal');
        const abrirFiltroBtn = document.getElementById('abrir-filtro-btn');
        const filtroAvancadoOverlay = document.getElementById('filtro-avancado-overlay');
        const filtroAvancadoPanel = document.getElementById('filtro-avancado-panel');
        const fecharFiltroBtn = document.getElementById('fechar-filtro-btn');
        const aplicarFiltrosBtn = document.getElementById('aplicar-filtros-btn');
        const limparFiltrosBtn = document.getElementById('limpar-filtros-btn');
        const filtrosAtivosContainer = document.getElementById('filtros-ativos-container');
        const filtroBadge = document.getElementById('filtro-badge');
        const deleteItemModal = document.getElementById('delete-item-modal');
        const deleteItemTitle = document.getElementById('delete-item-title');
        const deleteItemLabel = document.getElementById('delete-item-label');
        const deleteItemSelect = document.getElementById('delete-item-select');
        const deleteItemInfoSection = document.getElementById('delete-item-info-section');
        const deleteItemMessage = document.getElementById('delete-item-message');
        const deleteItemReplaceSection = document.getElementById('delete-item-replace-section');
        const deleteItemReplaceSelect = document.getElementById('delete-item-replace-select');
        const deleteItemAddReplacementBtn = document.getElementById('delete-item-add-replacement-btn');
        const cancelarDeleteItemBtn = document.getElementById('cancelar-delete-item');
        const confirmarDeleteSimplesBtn = document.getElementById('confirmar-delete-simples');
        const confirmarDeleteReplaceBtn = document.getElementById('confirmar-delete-replace');
        const confirmacaoModal = document.getElementById('confirmacao-modal');
        const confirmacaoTitulo = document.getElementById('confirmacao-titulo');
        const confirmacaoMensagem = document.getElementById('confirmacao-mensagem');
        const cancelarConfirmacaoBtn = document.getElementById('cancelar-confirmacao-btn');
        const confirmarAcaoBtn = document.getElementById('confirmar-acao-btn');
        const excluirLancamentoBtn = document.getElementById('excluir-lancamento-btn');
        const totalizerFooter = document.querySelector('footer');
        let fotosTemporarias = [];
        let categoryChartInstance = null;
        let filtrosAtivos = { status: null, categorias: [], fornecedores: [], carteiras: [] };
        let itemParaExcluir = { tipo: '', valor: '' };
        let abrirAddCategoriaModal, abrirAddCarteiraModal, abrirAddFornecedorModal;
        let onConfirmAction = null;
        const salvarDados = () => { localStorage.setItem('controleObraData', JSON.stringify({ lancamentos, categorias, carteiras, fornecedores })); };
        const carregarDados = () => { const dadosSalvos = localStorage.getItem('controleObraData'); if (dadosSalvos) { const data = JSON.parse(dadosSalvos); lancamentos = data.lancamentos || []; categorias = data.categorias || ['Estrutura e Vedações']; carteiras = data.carteiras || ['Conta Corrente']; fornecedores = data.fornecedores || ['Leroy Merlin']; } };
        const formatarMoeda = (valor) => (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatarDataSimples = (dataString) => { const dataObj = new Date(dataString + 'T12:00:00'); const dia = String(dataObj.getDate()).padStart(2, '0'); const mes = new Intl.DateTimeFormat('pt-BR', { month: 'short' }).format(dataObj).replace('.', ''); return `${dia} de ${mes}`; };
        const formatarData = (item) => { if (!item || !item.data) return { text: '', color: 'gray' }; const hoje = new Date(); hoje.setHours(0, 0, 0, 0); const dataLancamento = new Date(item.data + 'T12:00:00Z'); dataLancamento.setUTCHours(0, 0, 0, 0); const diffTime = dataLancamento.getTime() - hoje.getTime(); const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)); let tag = { text: '', color: 'gray' }; if(item.pago) { tag = { text: 'Pago', color: 'green' }; } else { if (diffDays < 0) { const diasAtraso = Math.abs(diffDays); tag = { text: `Vencido há ${diasAtraso} dia${diasAtraso > 1 ? 's' : ''}`, color: 'orange' }; } else if (diffDays === 0) { tag = { text: 'Vence hoje', color: 'orange' }; } else { tag = { text: `Vence em ${diffDays} dia${diffDays > 1 ? 's' : ''}`, color: 'gray' }; } } return tag; };
        const mostrarNotificacao = (mensagem, success = false) => { notificacaoMensagem.textContent = mensagem; notificacaoModal.classList.toggle('bg-red-500', !success); notificacaoModal.classList.toggle('bg-green-500', success); notificacaoModal.classList.remove('hidden'); setTimeout(() => { notificacaoModal.classList.remove('translate-x-[120%]'); }, 10); setTimeout(() => { notificacaoModal.classList.add('translate-x-[120%]'); setTimeout(() => { notificacaoModal.classList.add('hidden'); }, 300); }, 3000); };
        const popularDropdown = (dropdown, items, placeholder = null) => { const currentValue = dropdown.value; while (dropdown.firstChild) { dropdown.removeChild(dropdown.firstChild); } if (placeholder) { const option = new Option(placeholder, ""); option.disabled = true; dropdown.add(option); } const sortedItems = [...items].sort((a, b) => a.localeCompare(b)); sortedItems.forEach(item => { const option = new Option(item, item); dropdown.add(option); }); if (currentValue && sortedItems.includes(currentValue)) { dropdown.value = currentValue; } else if (!placeholder && sortedItems.length > 0) { dropdown.value = sortedItems[0]; } else { dropdown.value = ""; } };
        const atualizarTodosDropdownsEPopups = () => { const catVal = categoriaDropdown.value; const cartVal = carteiraDropdown.value; const fornVal = fornecedorDropdown.value; popularDropdown(categoriaDropdown, categorias); popularDropdown(carteiraDropdown, carteiras); popularDropdown(fornecedorDropdown, fornecedores); if (categorias.includes(catVal)) categoriaDropdown.value = catVal; if (carteiras.includes(cartVal)) carteiraDropdown.value = cartVal; if (fornecedores.includes(fornVal)) fornecedorDropdown.value = fornVal; inicializarFiltros(); atualizarPillsUI(); };
        const setupAddModal = (modal, form, inputId, dataArray, mainDropdown) => { let onSuccessCallback = null; const modalContent = modal.querySelector('div[id$="-content"]'); const abrirModal = (callback) => { onSuccessCallback = callback || null; form.reset(); modal.classList.remove('hidden'); setTimeout(() => { modalContent.classList.remove('scale-95', 'opacity-0'); }, 10); }; const fecharModal = () => { modalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => { form.reset(); modal.classList.add('hidden'); }, 300); }; modal.querySelector('.cancelar-add-item').addEventListener('click', fecharModal); modal.addEventListener('click', (e) => { if (e.target === modal) fecharModal(); }); form.addEventListener('submit', (e) => { e.preventDefault(); const input = document.getElementById(inputId); const novoItem = input.value.trim(); if (novoItem) { if (!dataArray.some(item => item.toLowerCase() === novoItem.toLowerCase())) { dataArray.push(novoItem); salvarDados(); atualizarTodosDropdownsEPopups(); mainDropdown.value = novoItem; if (onSuccessCallback) { onSuccessCallback(novoItem); } fecharModal(); } else { mostrarNotificacao(`Este item já existe!`); mainDropdown.value = dataArray.find(item => item.toLowerCase() === novoItem.toLowerCase()); fecharModal(); } } }); return abrirModal; };
        const handleExclusao = (tipo) => { itemParaExcluir = { tipo: tipo, valor: '' }; const dataArrays = { 'categoria': categorias, 'fornecedor': fornecedores, 'carteira': carteiras }; const titulos = { 'categoria': 'Categoria', 'fornecedor': 'Fornecedor', 'carteira': 'Carteira' }; deleteItemTitle.textContent = `Excluir ${titulos[tipo]}`; deleteItemLabel.textContent = `Selecione a ${titulos[tipo].toLowerCase()} para excluir:`; popularDropdown(deleteItemSelect, dataArrays[tipo], 'Selecione uma opção...'); deleteItemInfoSection.classList.add('hidden'); deleteItemReplaceSection.classList.add('hidden'); confirmarDeleteSimplesBtn.classList.add('hidden'); confirmarDeleteReplaceBtn.classList.add('hidden'); deleteItemSelect.value = ''; deleteItemModal.classList.remove('hidden'); };
        deleteItemSelect.addEventListener('change', () => { const valorSelecionado = deleteItemSelect.value; const { tipo } = itemParaExcluir; if (!valorSelecionado) return; itemParaExcluir.valor = valorSelecionado; const dataArrays = { 'categoria': categorias, 'fornecedor': fornecedores, 'carteira': carteiras }; const lancamentosUsando = lancamentos.filter(l => l[tipo] === valorSelecionado); deleteItemInfoSection.classList.remove('hidden'); if (lancamentosUsando.length === 0) { deleteItemMessage.textContent = `"${valorSelecionado}" não está em uso e pode ser excluído diretamente.`; deleteItemMessage.className = 'text-sm text-gray-600 mt-2 p-3 rounded-md bg-green-100 border border-green-200'; deleteItemReplaceSection.classList.add('hidden'); confirmarDeleteSimplesBtn.classList.remove('hidden'); confirmarDeleteReplaceBtn.classList.add('hidden'); } else { const plural = lancamentosUsando.length > 1 ? 's' : ''; deleteItemMessage.textContent = `Atenção: "${valorSelecionado}" está em uso por ${lancamentosUsando.length} lançamento${plural}. Para excluir, escolha um item para substituí-lo.`; deleteItemMessage.className = 'text-sm text-gray-600 mt-2 p-3 rounded-md bg-yellow-100 border border-yellow-200'; const outrasOpcoes = dataArrays[tipo].filter(i => i !== valorSelecionado); popularDropdown(deleteItemReplaceSelect, outrasOpcoes, 'Selecione a substituta...'); confirmarDeleteReplaceBtn.disabled = outrasOpcoes.length === 0; deleteItemReplaceSelect.disabled = outrasOpcoes.length === 0; deleteItemReplaceSection.classList.remove('hidden'); confirmarDeleteSimplesBtn.classList.add('hidden'); confirmarDeleteReplaceBtn.classList.remove('hidden'); } });
        cancelarDeleteItemBtn.addEventListener('click', () => deleteItemModal.classList.add('hidden'));
        deleteItemModal.addEventListener('click', (e) => { if (e.target === deleteItemModal) deleteItemModal.classList.add('hidden'); });
        deleteItemAddReplacementBtn.addEventListener('click', () => { const { tipo } = itemParaExcluir; const callback = (newItem) => { const dataArrays = { 'categoria': categorias, 'fornecedor': fornecedores, 'carteira': carteiras }; const outrasOpcoes = dataArrays[tipo].filter(i => i !== itemParaExcluir.valor); popularDropdown(deleteItemReplaceSelect, outrasOpcoes, 'Selecione a substituta...'); deleteItemReplaceSelect.value = newItem; deleteItemReplaceSelect.disabled = false; confirmarDeleteReplaceBtn.disabled = false; }; if (tipo === 'categoria') abrirAddCategoriaModal(callback); if (tipo === 'fornecedor') abrirAddFornecedorModal(callback); if (tipo === 'carteira') abrirAddCarteiraModal(callback); });
        confirmarDeleteSimplesBtn.addEventListener('click', () => { const { tipo, valor } = itemParaExcluir; if (!valor) return; if (tipo === 'categoria') { const index = categorias.indexOf(valor); if (index > -1) categorias.splice(index, 1); } if (tipo === 'fornecedor') { const index = fornecedores.indexOf(valor); if (index > -1) fornecedores.splice(index, 1); } if (tipo === 'carteira') { const index = carteiras.indexOf(valor); if (index > -1) carteiras.splice(index, 1); } salvarDados(); atualizarTodosDropdownsEPopups(); deleteItemModal.classList.add('hidden'); mostrarNotificacao(`"${valor}" excluído com sucesso.`, true); });
        confirmarDeleteReplaceBtn.addEventListener('click', () => { const { tipo, valor } = itemParaExcluir; const novoValor = deleteItemReplaceSelect.value; if (!valor || !novoValor) { mostrarNotificacao('Por favor, selecione um item para a substituição.', false); return; } lancamentos.forEach(lanc => { if (lanc[tipo] === valor) lanc[tipo] = novoValor; }); if (tipo === 'categoria') { const index = categorias.indexOf(valor); if (index > -1) categorias.splice(index, 1); } if (tipo === 'fornecedor') { const index = fornecedores.indexOf(valor); if (index > -1) fornecedores.splice(index, 1); } if (tipo === 'carteira') { const index = carteiras.indexOf(valor); if (index > -1) carteiras.splice(index, 1); } salvarDados(); atualizarTodosDropdownsEPopups(); if (!lancamentoModal.classList.contains('hidden') && tipo === 'categoria') { categoriaDropdown.value = novoValor; } renderizarLancamentos(); deleteItemModal.classList.add('hidden'); mostrarNotificacao(`"${valor}" foi substituído por "${novoValor}" e excluído.`, true); });
        const renderizarThumbnails = () => { fotosThumbnailsContainer.innerHTML = ''; fotosTemporarias.forEach((fotoSrc, index) => { const div = document.createElement('div'); div.className = 'relative'; div.innerHTML = `<img src="${fotoSrc}" class="w-full h-24 object-cover rounded-md"><button type="button" data-index="${index}" class="btn-remover-foto absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5 w-5 h-5 flex items-center justify-center text-xs">&times;</button>`; fotosThumbnailsContainer.appendChild(div); }); };
        const handleArquivosDeImagem = (files) => { [...files].forEach(file => { const reader = new FileReader(); reader.onload = (e) => { fotosTemporarias.push(e.target.result); renderizarThumbnails(); }; reader.readAsDataURL(file); }); };
        fotosThumbnailsContainer.addEventListener('click', (e) => { if (e.target.closest('.btn-remover-foto')) { const index = parseInt(e.target.closest('.btn-remover-foto').dataset.index); fotosTemporarias.splice(index, 1); renderizarThumbnails(); } });
        const abrirModalLancamento = (id = null) => { fotosTemporarias = []; document.getElementById('lancamento-valor').classList.remove('border-red-500'); const pagoCheckbox = document.getElementById('lancamento-pago'); const pagoStatusText = document.getElementById('pago-status-text'); if (id) { const lancamento = lancamentos.find(l => l.id === id); if (!lancamento) { mostrarNotificacao('Lançamento não encontrado.'); return; } lancamentoModalTitulo.textContent = 'Editar Lançamento'; excluirLancamentoBtn.classList.remove('hidden'); document.getElementById('lancamento-id').value = lancamento.id; document.getElementById('lancamento-data').value = lancamento.data; document.getElementById('lancamento-descricao').value = lancamento.descricao; pagoCheckbox.checked = lancamento.pago; document.getElementById('lancamento-valor').value = lancamento.valor ? String(lancamento.valor).replace('.', ',') : ''; fotosTemporarias = [...(lancamento.fotos || [])]; atualizarTodosDropdownsEPopups(); categoriaDropdown.value = lancamento.categoria; fornecedorDropdown.value = lancamento.fornecedor; carteiraDropdown.value = lancamento.carteira; } else { lancamentoForm.reset(); lancamentoModalTitulo.textContent = 'Novo Lançamento'; excluirLancamentoBtn.classList.add('hidden'); document.getElementById('lancamento-id').value = ''; document.getElementById('lancamento-data').valueAsDate = new Date(); document.getElementById('lancamento-valor').value = ''; pagoCheckbox.checked = false; atualizarTodosDropdownsEPopups(); } if (pagoCheckbox.checked) { pagoStatusText.textContent = 'Sim'; pagoStatusText.classList.remove('text-gray-500'); pagoStatusText.classList.add('text-green-600'); } else { pagoStatusText.textContent = 'Não'; pagoStatusText.classList.add('text-gray-500'); pagoStatusText.classList.remove('text-green-600'); } renderizarThumbnails(); lancamentoModal.classList.remove('hidden'); };
        const fecharModalLancamento = () => lancamentoModal.classList.add('hidden');
        lancamentoForm.addEventListener('submit', (e) => { e.preventDefault(); const id = parseInt(document.getElementById('lancamento-id').value); const valorInput = document.getElementById('lancamento-valor'); const isValorEmpty = valorInput.value.trim() === ''; if (!id && isValorEmpty) { mostrarNotificacao('O campo Valor é obrigatório para novos lançamentos.'); valorInput.classList.add('border-red-500'); return; } valorInput.classList.remove('border-red-500'); const valorNumerico = parseFloat(valorInput.value.replace(',', '.')) || 0; const dados = { data: document.getElementById('lancamento-data').value, descricao: document.getElementById('lancamento-descricao').value, categoria: categoriaDropdown.value, fornecedor: fornecedorDropdown.value, carteira: carteiraDropdown.value, pago: document.getElementById('lancamento-pago').checked, fotos: [...fotosTemporarias] }; if (id) { const index = lancamentos.findIndex(l => l.id === id); if (index !== -1) { const lancamentoAtualizado = { ...lancamentos[index], ...dados }; if (!isValorEmpty) { lancamentoAtualizado.valor = valorNumerico; } lancamentos[index] = lancamentoAtualizado; } } else { const novoId = lancamentos.length > 0 ? Math.max(...lancamentos.map(l => l.id)) + 1 : 1; lancamentos.push({ id: novoId, ...dados, valor: valorNumerico }); } salvarDados(); renderizarLancamentos(); fecharModalLancamento(); });
        const abrirGaleria = (lancamentoId) => { const lancamento = lancamentos.find(l => l.id === lancamentoId); if (!lancamento) return; galeriaTitulo.textContent = lancamento.descricao; galeriaContainer.innerHTML = ''; if (lancamento.fotos && lancamento.fotos.length > 0) { lancamento.fotos.forEach(src => { galeriaContainer.innerHTML += `<img src="${src}" class="w-full h-auto object-cover rounded-md shadow-sm cursor-pointer hover:opacity-80 transition-opacity">`; }); } else { galeriaContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">Nenhuma foto para este lançamento.</p>`; } galeriaModal.classList.remove('hidden'); };
        const fecharGaleria = () => galeriaModal.classList.add('hidden');
        let scale = 1, currentScale = 1, pointX = 0, pointY = 0, start = { x: 0, y: 0 }, initialPinchDistance = 0; const setTransform = () => zoomedImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; const getDistance = (p1, p2) => Math.sqrt(Math.pow(p2.clientX - p1.clientX, 2) + Math.pow(p2.clientY - p1.clientY, 2)); const handleTouchStart = (e) => { e.preventDefault(); if (e.touches.length === 2) initialPinchDistance = getDistance(e.touches[0], e.touches[1]); else if (e.touches.length === 1) start = { x: e.touches[0].clientX - pointX, y: e.touches[0].clientY - pointY }; }; const handleTouchMove = (e) => { e.preventDefault(); if (e.touches.length === 2 && initialPinchDistance > 0) { const newPinchDistance = getDistance(e.touches[0], e.touches[1]); scale = currentScale * (newPinchDistance / initialPinchDistance); scale = Math.max(1, Math.min(scale, 5)); setTransform(); } else if (e.touches.length === 1) { pointX = e.touches[0].clientX - start.x; pointY = e.touches[0].clientY - start.y; setTransform(); } }; const handleTouchEnd = (e) => { if (e.touches.length < 2) { currentScale = scale; initialPinchDistance = 0; } }; const abrirZoom = (src) => { scale = 1; currentScale = 1; pointX = 0, pointY = 0; setTransform(); zoomedImage.src = src; zoomModal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; zoomedImage.addEventListener('touchstart', handleTouchStart); zoomedImage.addEventListener('touchmove', handleTouchMove); zoomedImage.addEventListener('touchend', handleTouchEnd); }; const fecharZoom = () => { zoomModal.classList.add('hidden'); document.body.style.overflow = ''; zoomedImage.removeEventListener('touchstart', handleTouchStart); zoomedImage.removeEventListener('touchmove', handleTouchMove); zoomedImage.removeEventListener('touchend', handleTouchEnd); };
        const renderizarResumoObra = () => { const totalPago = lancamentos.filter(l => l.pago).reduce((soma, l) => soma + (l.valor || 0), 0); const totalPendente = lancamentos.filter(l => !l.pago).reduce((soma, l) => soma + (l.valor || 0), 0); const custoTotal = totalPago + totalPendente; document.getElementById('resumo-pago').textContent = formatarMoeda(totalPago); document.getElementById('resumo-pendente').textContent = formatarMoeda(totalPendente); document.getElementById('resumo-custo-total').textContent = formatarMoeda(custoTotal); };
        const renderizarGraficoCategorias = () => { if (categoryChartInstance) categoryChartInstance.destroy(); const gastosPorCategoria = lancamentos.reduce((acc, lanc) => { acc[lanc.categoria] = (acc[lanc.categoria] || 0) + (Number(lanc.valor) || 0); return acc; }, {}); const sortedCategories = Object.entries(gastosPorCategoria).sort(([, a], [, b]) => b - a); const labels = sortedCategories.map(([categoria]) => categoria); const data = sortedCategories.map(([, valor]) => valor); const colors = labels.map(() => `rgba(124, 58, 237, ${Math.random() * 0.5 + 0.4})`); const ctx = document.getElementById('category-chart').getContext('2d'); categoryChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Total Gasto', data, backgroundColor: colors, borderColor: colors.map(color => color.replace('0.8', '1')), borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: false }, tooltip: { callbacks: { label: (context) => formatarMoeda(context.raw) } } }, scales: { x: { beginAtZero: true, ticks: { callback: (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', notation: 'compact' }).format(value) } } } } }); };
        const fecharFiltroPanel = () => { filtroAvancadoPanel.classList.add('translate-x-full'); filtroAvancadoOverlay.classList.add('hidden'); };
        const abrirFiltroPanel = () => { filtroAvancadoPanel.classList.remove('translate-x-full'); filtroAvancadoOverlay.classList.remove('hidden'); atualizarPillsUI(); };
        const criarPill = (text, value, group) => { const pill = document.createElement('button'); pill.className = 'px-3 py-1 border rounded-full text-sm cursor-pointer hover:bg-gray-200 transition-colors'; pill.textContent = text; pill.dataset.value = value; pill.dataset.group = group; return pill; };
        const atualizarPillsUI = () => { document.querySelectorAll('#filtro-avancado-panel .accordion-content button').forEach(pill => { const { group, value } = pill.dataset; let isActive = (group === 'status') ? (filtrosAtivos.status === value) : filtrosAtivos[group]?.includes(value); pill.classList.toggle('bg-violet-500', isActive); pill.classList.toggle('text-white', isActive); pill.classList.toggle('border-violet-500', isActive); pill.classList.toggle('hover:bg-gray-200', !isActive); }); let count = (filtrosAtivos.status ? 1 : 0) + filtrosAtivos.categorias.length + filtrosAtivos.fornecedores.length + filtrosAtivos.carteiras.length; filtroBadge.textContent = count; filtroBadge.classList.toggle('hidden', count === 0); };
        const handlePillClick = (e) => { const pill = e.target; if (!pill.dataset.group) return; const { group, value } = pill.dataset; if (group === 'status') { filtrosAtivos.status = (filtrosAtivos.status === value) ? null : value; } else { if (!filtrosAtivos[group]) filtrosAtivos[group] = []; const index = filtrosAtivos[group].indexOf(value); if (index > -1) filtrosAtivos[group].splice(index, 1); else filtrosAtivos[group].push(value); } atualizarPillsUI(); };
        const inicializarFiltros = () => { const statusContainer = document.getElementById('filtro-status-container'); const categoriasContainer = document.getElementById('filtro-categorias-container'); const fornecedoresContainer = document.getElementById('filtro-fornecedores-container'); const carteirasContainer = document.getElementById('filtro-carteiras-container'); statusContainer.innerHTML = ''; ['Pagos', 'Não Pago'].forEach(status => statusContainer.appendChild(criarPill(status, status === 'Pagos' ? 'pago' : 'aberto', 'status'))); categoriasContainer.innerHTML = ''; [...categorias].sort().forEach(cat => categoriasContainer.appendChild(criarPill(cat, cat, 'categorias'))); fornecedoresContainer.innerHTML = ''; [...fornecedores].sort().forEach(forn => fornecedoresContainer.appendChild(criarPill(forn, forn, 'fornecedores'))); carteirasContainer.innerHTML = ''; [...carteiras].sort().forEach(cart => carteirasContainer.appendChild(criarPill(cart, cart, 'carteiras'))); };
        const renderizarLancamentos = () => { let lancamentosFiltrados = [...lancamentos]; const filtroTexto = campoPesquisa.value.toLowerCase(); if (filtroTexto) lancamentosFiltrados = lancamentosFiltrados.filter(lanc => lanc.descricao.toLowerCase().includes(filtroTexto)); if (filtrosAtivos.status) { const pago = filtrosAtivos.status === 'pago'; lancamentosFiltrados = lancamentosFiltrados.filter(lanc => lanc.pago === pago); } if (filtrosAtivos.categorias.length > 0) lancamentosFiltrados = lancamentosFiltrados.filter(lanc => filtrosAtivos.categorias.includes(lanc.categoria)); if (filtrosAtivos.fornecedores.length > 0) lancamentosFiltrados = lancamentosFiltrados.filter(lanc => filtrosAtivos.fornecedores.includes(lanc.fornecedor)); if (filtrosAtivos.carteiras.length > 0) lancamentosFiltrados = lancamentosFiltrados.filter(lanc => filtrosAtivos.carteiras.includes(lanc.carteira)); const agrupadoPorMes = [...lancamentosFiltrados].sort((a, b) => new Date(b.data) - new Date(a.data)).reduce((acc, lanc) => { const dataObj = new Date(lanc.data + 'T12:00:00'); const mesAno = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' }).format(dataObj); if (!acc[mesAno]) acc[mesAno] = []; acc[mesAno].push(lanc); return acc; }, {}); containerLista.innerHTML = ''; if (lancamentosFiltrados.length === 0) { containerLista.innerHTML = `<div class="text-center py-16 px-6 bg-white rounded-2xl shadow-sm border border-gray-200"><svg class="mx-auto h-24 w-24 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg><h3 class="mt-4 text-lg font-semibold text-gray-700">Nenhum lançamento encontrado</h3><p class="mt-1 text-sm text-gray-500">Comece adicionando uma nova despesa ou receita no botão de mais.</p></div>`; return; } const mesesOrdenados = Object.keys(agrupadoPorMes).sort((a, b) => { const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"]; const [mesA, , anoA] = a.split(' '); const [mesB, , anoB] = b.split(' '); return new Date(anoB, meses.indexOf(mesB.toLowerCase())) - new Date(anoA, meses.indexOf(mesA.toLowerCase())); }); for (const mesAno of mesesOrdenados) { const lancamentosDoMes = agrupadoPorMes[mesAno]; const totalMes = lancamentosDoMes.reduce((soma, item) => soma + Number(item.valor || 0), 0); const mesHeaderHTML = `<div class="flex justify-between items-center mb-2"><h2 class="font-bold text-lg text-gray-900">${mesAno.charAt(0).toUpperCase() + mesAno.slice(1)}</h2><p class="text-gray-600 font-semibold">${formatarMoeda(totalMes)}</p></div>`; containerLista.insertAdjacentHTML('beforeend', mesHeaderHTML); const listContainer = document.createElement('div'); listContainer.className = 'space-y-3'; lancamentosDoMes.forEach(item => { const tagInfo = formatarData(item); const dataSimples = formatarDataSimples(item.data); const tagClasses = { 'green': 'bg-green-100 text-green-800', 'orange': 'bg-amber-100 text-amber-800', 'gray': 'bg-gray-100 text-gray-800' }; const statusTagHTML = `<span class="px-2 py-0.5 text-xs font-semibold ${tagClasses[tagInfo.color]} rounded-md">${tagInfo.text}</span>`; const liquidarBtn = !item.pago ? `<button class="btn-toggle-pago bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600" data-id="${item.id}">Liquidar</button>` : ''; const cardHTML = `<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4"><div class="flex justify-between items-center mb-2"><div class="flex items-center gap-2 flex-wrap">${statusTagHTML}<p class="text-sm text-gray-500 font-medium">${dataSimples}</p></div><p class="font-bold text-xl text-gray-800 whitespace-nowrap pl-2">${formatarMoeda(item.valor)}</p></div><div><p class="font-semibold text-base text-gray-900 truncate" title="${item.descricao}">${item.descricao}</p><p class="text-sm text-gray-500 mt-1">${item.categoria}</p><p class="text-sm text-gray-500">${item.fornecedor} &bull; ${item.carteira}</p></div><div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100" style="min-height: 52px;"><div class="flex items-center gap-1"><button class="btn-galeria text-sm text-violet-600 font-semibold p-2 rounded-lg hover:bg-violet-50 ${item.fotos && item.fotos.length > 0 ? '' : 'hidden'}" data-id="${item.id}">Ver Fotos (${item.fotos.length})</button></div><div class="flex items-center gap-2"><button class="btn-editar p-2 rounded-full bg-gray-100 hover:bg-gray-200" data-id="${item.id}" title="Editar lançamento"><svg class="w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.862 4.487zm0 0L19.5 7.125"></path></svg></button>${liquidarBtn}</div></div></div>`; listContainer.insertAdjacentHTML('beforeend', cardHTML); }); containerLista.appendChild(listContainer); } const totalExibido = lancamentosFiltrados.reduce((soma, item) => soma + Number(item.valor || 0), 0); resumoTotalContainer.innerHTML = `<div><span class="font-semibold">Total Exibido</span><p class="text-xs text-gray-500">Exibindo ${lancamentosFiltrados.length} de ${lancamentos.length} itens</p></div><span class="font-bold text-lg">${formatarMoeda(totalExibido)}</span>`; };
        const mostrarConfirmacao = (titulo, mensagem, onConfirm) => { confirmacaoTitulo.textContent = titulo; confirmacaoMensagem.textContent = mensagem; onConfirmAction = onConfirm; confirmacaoModal.classList.remove('hidden'); };
        const fecharConfirmacao = () => { confirmacaoModal.classList.add('hidden'); onConfirmAction = null; };
        document.addEventListener('DOMContentLoaded', () => { carregarDados(); atualizarTodosDropdownsEPopups(); renderizarLancamentos(); cancelarConfirmacaoBtn.addEventListener('click', fecharConfirmacao); confirmacaoModal.addEventListener('click', (e) => { if (e.target === confirmacaoModal) fecharConfirmacao(); }); confirmarAcaoBtn.addEventListener('click', () => { if (typeof onConfirmAction === 'function') { onConfirmAction(); } fecharConfirmacao(); }); excluirLancamentoBtn.addEventListener('click', () => { const id = parseInt(document.getElementById('lancamento-id').value); if (!id) return; const onConfirmDelete = () => { const index = lancamentos.findIndex(l => l.id === id); if (index > -1) { lancamentos.splice(index, 1); salvarDados(); fecharModalLancamento(); renderizarLancamentos(); mostrarNotificacao('Lançamento excluído com sucesso!', true); } }; mostrarConfirmacao('Excluir Lançamento', 'Tem certeza que deseja excluir este lançamento? Esta ação não pode ser desfeita.', onConfirmDelete); }); document.querySelectorAll('.accordion-header').forEach(header => { header.addEventListener('click', () => { header.nextElementSibling.classList.toggle('hidden'); header.querySelector('svg').classList.toggle('rotate-180'); }); }); filtroAvancadoPanel.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.dataset.group) handlePillClick(e); }); abrirFiltroBtn.addEventListener('click', abrirFiltroPanel); fecharFiltroBtn.addEventListener('click', fecharFiltroPanel); filtroAvancadoOverlay.addEventListener('click', fecharFiltroPanel); aplicarFiltrosBtn.addEventListener('click', () => { fecharFiltroPanel(); renderizarLancamentos(); }); limparFiltrosBtn.addEventListener('click', () => { filtrosAtivos = { status: null, categorias: [], fornecedores: [], carteiras: [] }; atualizarPillsUI(); renderizarLancamentos(); fecharFiltroPanel(); }); abrirAddCategoriaModal = setupAddModal(addCategoriaModal, addCategoriaForm, 'nova-categoria-nome', categorias, categoriaDropdown); abrirAddCarteiraModal = setupAddModal(addCarteiraModal, addCarteiraForm, 'nova-carteira-nome', carteiras, carteiraDropdown); abrirAddFornecedorModal = setupAddModal(addFornecedorModal, addFornecedorForm, 'nova-fornecedor-nome', fornecedores, fornecedorDropdown); lancamentoForm.addEventListener('click', (e) => { const addBtn = e.target.closest('.btn-adicionar'); const delBtn = e.target.closest('.btn-excluir'); if (addBtn) { const tipo = addBtn.dataset.tipo; if (tipo === 'categoria') abrirAddCategoriaModal(); if (tipo === 'fornecedor') abrirAddFornecedorModal(); if (tipo === 'carteira') abrirAddCarteiraModal(); } if (delBtn) handleExclusao(delBtn.dataset.tipo); }); const valorInput = document.getElementById('lancamento-valor'); valorInput.addEventListener('input', (e) => { let value = e.target.value; value = value.replace(/\./g, ','); value = value.replace(/[^0-9,]/g, ''); const parts = value.split(','); if (parts.length > 2) { value = parts[0] + ',' + parts.slice(1).join(''); } e.target.value = value; }); const pagoCheckbox = document.getElementById('lancamento-pago'); const pagoStatusText = document.getElementById('pago-status-text'); pagoCheckbox.addEventListener('change', (e) => { if (e.target.checked) { pagoStatusText.textContent = 'Sim'; pagoStatusText.classList.remove('text-gray-500'); pagoStatusText.classList.add('text-green-600'); } else { pagoStatusText.textContent = 'Não'; pagoStatusText.classList.add('text-gray-500'); pagoStatusText.classList.remove('text-green-600'); } }); containerLista.addEventListener('click', (e) => { const btnToggle = e.target.closest('.btn-toggle-pago'); const btnGaleria = e.target.closest('.btn-galeria'); const btnEditar = e.target.closest('.btn-editar'); if (btnEditar) { const id = parseInt(btnEditar.dataset.id); abrirModalLancamento(id); } else if (btnToggle) { const lancamento = lancamentos.find(l => l.id === parseInt(btnToggle.dataset.id)); if (lancamento) { lancamento.pago = !lancamento.pago; salvarDados(); renderizarLancamentos(); } } else if (btnGaleria) { abrirGaleria(parseInt(btnGaleria.dataset.id)); } }); campoPesquisa.addEventListener('input', () => renderizarLancamentos()); lancamentosTabBtn.addEventListener('click', () => alternarAbas('lancamentos')); relatoriosTabBtn.addEventListener('click', () => alternarAbas('relatorios')); abrirNovoLancamentoBtn.addEventListener('click', () => abrirModalLancamento()); fecharLancamentoModalBtn.onclick = fecharModalLancamento; cancelarLancamentoBtn.onclick = fecharModalLancamento; lancamentoModal.onclick = (e) => { if (e.target === lancamentoModal) fecharModalLancamento(); }; galeriaContainer.addEventListener('click', (e) => { if (e.target.tagName === 'IMG') abrirZoom(e.target.src); }); fecharGaleriaBtn.onclick = fecharGaleria; fecharZoomBtn.onclick = fecharZoom; galeriaModal.onclick = (e) => { if (e.target === galeriaModal) fecharGaleria(); }; btnGaleriaUpload.addEventListener('click', () => galeriaInput.click()); btnCameraUpload.addEventListener('click', () => cameraInput.click()); galeriaInput.addEventListener('change', (e) => handleArquivosDeImagem(e.target.files)); cameraInput.addEventListener('change', (e) => handleArquivosDeImagem(e.target.files)); const fecharMenu = () => { menuLateral.classList.add('-translate-x-full'); menuLateralOverlay.classList.add('hidden'); }; abrirMenuBtn.addEventListener('click', () => { menuLateral.classList.remove('-translate-x-full'); menuLateralOverlay.classList.remove('hidden'); }); menuLateralOverlay.addEventListener('click', fecharMenu); menuLancamentosBtn.addEventListener('click', (e) => { e.preventDefault(); mainContent.classList.remove('hidden'); backupContent.classList.add('hidden'); alternarAbas('lancamentos'); fecharMenu(); }); menuBackupBtn.addEventListener('click', (e) => { e.preventDefault(); mainContent.classList.add('hidden'); backupContent.classList.remove('hidden'); totalizerFooter.classList.add('hidden'); abrirNovoLancamentoBtn.classList.add('hidden'); fecharMenu(); }); exportarBtn.addEventListener('click', () => { const dataToSave = { lancamentos, categorias, carteiras, fornecedores }; const dataStr = JSON.stringify(dataToSave, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.download = `backup_obra_${new Date().toISOString().slice(0, 10)}.json`; link.href = url; link.click(); URL.revokeObjectURL(url); mostrarNotificacao('Backup exportado com sucesso!', true); window.OneSignalDeferred.push(function(OneSignal) { OneSignal.sendSelfNotification( 'Backup da Obra Realizado!', `O backup foi gerado e salvo com sucesso em ${new Date().toLocaleTimeString()}.`, window.location.href ); }); }); importarBtn.addEventListener('click', () => importarInput.click()); importarInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const data = JSON.parse(event.target.result); if (data.lancamentos && data.categorias && data.carteiras && data.fornecedores) { lancamentos = data.lancamentos; categorias = data.categorias; carteiras = data.carteiras; fornecedores = data.fornecedores; salvarDados(); atualizarTodosDropdownsEPopups(); renderizarLancamentos(); mostrarNotificacao('Backup importado com sucesso!', true); } else { mostrarNotificacao('Arquivo de backup inválido.'); } } catch (error) { mostrarNotificacao('Erro ao ler o arquivo de backup.'); } }; reader.readAsText(file); importarInput.value = ''; }); const toggleBtn = document.getElementById('toggle-totalizer-btn'); const footer = document.getElementById('totalizer-footer'); const arrowDown = document.getElementById('totalizer-arrow-down'); const arrowUp = document.getElementById('totalizer-arrow-up'); const applyTotalizerState = () => { const isCollapsed = localStorage.getItem('totalizerCollapsed') === 'true'; footer.dataset.collapsed = isCollapsed; if (isCollapsed) { const height = document.getElementById('totalizer-footer-content').offsetHeight; footer.style.transform = `translateY(${height}px)`; arrowDown.classList.add('hidden'); arrowUp.classList.remove('hidden'); } else { footer.style.transform = 'translateY(0)'; arrowDown.classList.remove('hidden'); arrowUp.classList.add('hidden'); } }; toggleBtn.addEventListener('click', () => { const isCollapsed = footer.dataset.collapsed === 'true'; localStorage.setItem('totalizerCollapsed', !isCollapsed); applyTotalizerState(); }); alternarAbas('lancamentos'); mainContent.classList.remove('hidden'); backupContent.classList.add('hidden'); applyTotalizerState(); });
        const alternarAbas = (aba) => { const isLancamentos = aba === 'lancamentos'; lancamentosTabBtn.setAttribute('aria-selected', isLancamentos); relatoriosTabBtn.setAttribute('aria-selected', !isLancamentos); lancamentosTabBtn.classList.toggle('text-violet-600', isLancamentos); lancamentosTabBtn.classList.toggle('border-violet-600', isLancamentos); lancamentosTabBtn.classList.toggle('text-gray-500', !isLancamentos); lancamentosTabBtn.classList.toggle('border-transparent', !isLancamentos); relatoriosTabBtn.classList.toggle('text-violet-600', !isLancamentos); relatoriosTabBtn.classList.toggle('border-violet-600', !isLancamentos); relatoriosTabBtn.classList.toggle('text-gray-500', isLancamentos); relatoriosTabBtn.classList.toggle('border-transparent', isLancamentos); lancamentosContent.classList.toggle('hidden', !isLancamentos); relatoriosContent.classList.toggle('hidden', isLancamentos); totalizerFooter.classList.toggle('hidden', !isLancamentos); if (!isLancamentos) { renderizarResumoObra(); renderizarGraficoCategorias(); } };
    </script>
</body>
</html>
